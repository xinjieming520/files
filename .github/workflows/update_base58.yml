name: Auto Encode Config to Base58

on:
  push:
    paths:
      - 'video/config_moontv.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install base58

      - name: Encode file to Base58
        run: |
          python -c "
          import base58
          import os

          input_path = 'video/config_moontv.json'
          output_path = 'video/config_moontv_base58.json'

          if os.path.exists(input_path):
              with open(input_path, 'rb') as f:
                  content = f.read()
              
              encoded = base58.b58encode(content)
              
              with open(output_path, 'wb') as f:
                  f.write(encoded)
              
              print(f'Successfully encoded {input_path} to {output_path}')
          else:
              print(f'Error: File {input_path} not found!')
              exit(1)
          "

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add video/config_moontv_base58.json
          
          if git diff --staged --quiet; then
            echo "No changes detected. Skipping commit."
          else
            git commit -m "Auto-update config_moontv_base58.json with Base58 encoding"
            git push
          fi
